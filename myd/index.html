<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#1a1b26',
                        panel: '#24283b',
                        accent: '#7aa2f7'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark text-gray-200 font-sans h-screen flex overflow-hidden">

    <aside class="w-64 bg-panel flex flex-col border-r border-gray-700">
        <div class="p-6 flex items-center space-x-3">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg"></div>
            <span class="text-xl font-bold tracking-wider">My Drive</span>
        </div>

        <nav class="flex-1 px-4 space-y-2 mt-4">
            <a href="#" class="flex items-center space-x-3 bg-gray-700/50 px-4 py-3 rounded-xl text-accent">
                <i data-lucide="hard-drive"></i>
                <span>マイドライブ</span>
            </a>
            <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-700/30 transition">
                <i data-lucide="clock"></i>
                <span>最近のファイル</span>
            </a>
            <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-700/30 transition">
                <i data-lucide="star"></i>
                <span>スター付き</span>
            </a>
            <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-gray-700/30 transition">
                <i data-lucide="trash-2"></i>
                <span>ゴミ箱</span>
            </a>
        </nav>

        <div class="p-6">
            <div class="bg-gray-800 rounded-xl p-4">
                <div class="flex justify-between text-xs text-gray-400 mb-2">
                    <span>容量</span>
                    <span>1 GB / 5 GB</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-1.5">
                    <div class="bg-accent h-1.5 rounded-full" style="width: 20%"></div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col">
        <header class="h-20 border-b border-gray-700 flex items-center justify-between px-8 bg-dark/50 backdrop-blur-md">
            <div class="relative w-96">
                <i data-lucide="search" class="absolute left-4 top-3 text-gray-400 w-5 h-5"></i>
                <input type="text" placeholder="ファイルを検索..." class="w-full bg-panel text-white pl-12 pr-4 py-2.5 rounded-xl border border-gray-700 focus:outline-none focus:border-accent">
            </div>

            <label class="cursor-pointer bg-accent hover:bg-blue-400 text-dark font-bold py-2.5 px-6 rounded-xl flex items-center space-x-2 transition shadow-lg shadow-blue-500/20">
                <i data-lucide="plus"></i>
                <span>アップロード</span>
                <input type="file" id="fileInput" class="hidden">
            </label>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <h2 class="text-lg font-semibold mb-6 text-gray-300">ファイル一覧</h2>
            
            <div id="fileGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <p class="text-gray-500 col-span-full text-center py-20">読み込み中...</p>
            </div>
        </div>
    </main>

    <script>
        // 1. Supabaseの設定（自分のプロジェクトのURLとキーに書き換えてください）
        const SUPABASE_URL = 'https://tuhymxfzsexjvrxhfioh.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_DngO4HJhUeI5nm0uIvTa2A_K05t2agR';
        
        // クライアントの作成
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // DOM要素
        const fileInput = document.getElementById('fileInput');
        const fileGrid = document.getElementById('fileGrid');

        // 2. アイコンを初期化
        lucide.createIcons();

        // 3. ファイルリストを取得して表示する関数
        async function loadFiles() {
            // 'files'というバケットからファイル一覧を取得
            const { data, error } = await _supabase.storage.from('files').list('', {
                limit: 100,
                offset: 0,
                sortBy: { column: 'created_at', order: 'desc' },
            });

            if (error) {
                console.error('Error loading files:', error);
                fileGrid.innerHTML = '<p class="text-red-400 col-span-full text-center">読み込みエラー（Supabaseの設定を確認してください）</p>';
                return;
            }

            // HTMLを生成
            fileGrid.innerHTML = '';
            
            if (data.length === 0) {
                fileGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-20">ファイルがありません。右上のボタンからアップロードしてください。</p>';
                return;
            }

            data.forEach(file => {
                // 画像かどうか判定してプレビューURLを作成
                const isImage = file.metadata.mimetype?.startsWith('image/');
                const fileUrl = `${SUPABASE_URL}/storage/v1/object/public/files/${file.name}`;
                
                // アイコンの決定
                let iconHtml = `<i data-lucide="file" class="w-12 h-12 text-gray-400 mb-3"></i>`;
                if (isImage) {
                    iconHtml = `<img src="${fileUrl}" class="w-full h-32 object-cover rounded-lg mb-3" alt="${file.name}">`;
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.csv')) {
                    iconHtml = `<i data-lucide="sheet" class="w-12 h-12 text-green-500 mb-3"></i>`;
                }

                const cardHtml = `
                    <div class="bg-panel p-4 rounded-2xl hover:bg-gray-700 transition group cursor-pointer border border-transparent hover:border-gray-600">
                        <div class="flex flex-col items-center">
                            ${iconHtml}
                            <div class="w-full">
                                <p class="text-sm font-medium truncate text-gray-200">${file.name}</p>
                                <p class="text-xs text-gray-500 mt-1">${(file.metadata.size / 1024 / 1024).toFixed(2)} MB</p>
                            </div>
                        </div>
                    </div>
                `;
                fileGrid.innerHTML += cardHtml;
            });
            lucide.createIcons(); // 新しく追加されたアイコンを描画
        }

        // 4. ファイルアップロード処理
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const buttonText = document.querySelector('label span');
            const originalText = buttonText.innerText;
            buttonText.innerText = "送信中...";

            try {
                // 日本語ファイル名などのトラブルを防ぐためエンコードするか、UUIDを使うのが一般的ですが今回はそのまま
                const filePath = file.name; 

                const { data, error } = await _supabase.storage
                    .from('files')
                    .upload(filePath, file, {
                        upsert: true
                    });

                if (error) throw error;

                alert('アップロード完了！');
                loadFiles(); // リストを再読み込み
            } catch (error) {
                alert('エラー: ' + error.message);
            } finally {
                buttonText.innerText = originalText;
                fileInput.value = ''; // 入力をリセット
            }
        });

        // 初回読み込み
        // 注: Supabaseの設定値がダミーのため、最初はエラーになります。
        // 正しいURLとKEYを入れると動きます。
        // loadFiles(); 
    </script>
</body>
</html>